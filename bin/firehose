#!/usr/bin/env ruby

require_relative "../firehose"
require_relative "../deploys"

BLACKLIST = (ENV['BLACKLIST'] || '').split(',')

hose = Firehose.new(
  channel: ENV["PUSHER_CHANNEL"],
  key:     ENV["PUSHER_KEY"],
  secret:  ENV["PUSHER_SECRET"])

hose.on_json do |data|
  if data[:action] == 'deploy-app'
    name = data[:target]
    if BLACKLIST.find{ |string| name =~ /^#{string}/ }
      puts "BLACKLIST: #{name}"
    else
      puts "DEPLOY: #{name}"
      Deploys.add(name)
    end
  end
end
